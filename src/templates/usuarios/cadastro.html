{% extends 'base.html' %} {% block head_scripts %} {# Inclua o SDK do Google
Identity Platform NO HEAD #}
<script src="https://accounts.google.com/gsi/client" async defer></script>
{% endblock head_scripts %} {% block content %}
<div
  id="g_id_onload"
  data-client_id="{{ GOOGLE_CLIENT_ID }}"
  data-callback="handleCredentialResponse"
  data-auto_select="false"
  {#
  Use
  false
  para
  evitar
  o
  one-tap
  automático
  se
  não
  for
  desejado
  #}
  data-context="{{ 'signin' if request.path == url_for('usuarios.login') else 'signup' }}"
  {#
  Contexto
  dinâmico
  #}
  data-ux_mode="popup"
>
  {# Ou "redirect" se preferir um redirect completo #}
</div>
<div
  class="flex items-center justify-center min-h-[calc(100vh-80px)] bg-purplebrandextra_light py-12"
>
  <div
    class="bg-white p-8 md:p-10 rounded-2xl shadow-xl w-full max-w-md border border-gray-100 relative"
  >
    <div
      class="absolute -top-10 left-1/2 -translate-x-1/2 bg-purplebrand p-4 rounded-full shadow-lg"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-10 w-10 text-white"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
        />
      </svg>
    </div>

    <div class="text-center mb-8 mt-8">
      <h2 class="text-3xl font-bold text-graydark mb-2">
        Criar sua conta YummyGo
      </h2>
      <p class="text-gray-600">Peça suas comidas favoritas em instantes.</p>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %} {% if
    messages %}
    <div class="mb-4">
      {% for category, message in messages %}
      <div
        class="p-3 rounded-md text-sm {% if category == 'error' %}bg-red-100 text-red-700{% elif category == 'success' %}bg-green-100 text-green-700{% else %}bg-blue-100 text-blue-700{% endif %}"
      >
        {{ message }}
      </div>
      {% endfor %}
    </div>
    {% endif %} {% endwith %} {# SEU BOTÃO CUSTOMIZADO DO GOOGLE - Remova
    quaisquer divs 'g_id_onload' e 'g_id_signin' aqui! #}
    <div class="mb-6">
      <button
        id="google-signin-button"
        class="w-full flex items-center justify-center bg-purplebrandlight text-white font-semibold py-3 px-4 rounded-full shadow-md hover:bg-purplebrand transition-all duration-300"
      >
        <img
          src="{{ url_for('static', filename='google_logo.svg') }}"
          alt="Google Logo"
          class="w-5 h-5 mr-3"
        />
        Continuar com Google
      </button>
    </div>

    <div class="relative flex items-center justify-center mb-6">
      <div class="flex-grow border-t border-gray-300"></div>
      <span class="flex-shrink mx-4 text-gray-500">ou</span>
      <div class="flex-grow border-t border-gray-300"></div>
    </div>

    <form method="POST" action="{{ url_for('usuarios.cadastro') }}">
      <div class="mb-4">
        <label for="nome" class="block text-gray-700 text-sm font-semibold mb-2"
          >Nome Completo:</label
        >
        <input
          type="text"
          id="nome"
          name="nome"
          required
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purplebrand focus:border-transparent transition-all duration-300"
          placeholder="Seu nome completo"
        />
      </div>

      <div class="mb-4">
        <label
          for="email"
          class="block text-gray-700 text-sm font-semibold mb-2"
          >Email:</label
        >
        <input
          type="email"
          id="email"
          name="email"
          required
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purplebrand focus:border-transparent transition-all duration-300"
          placeholder="seu.email@example.com"
        />
      </div>

      <div class="mb-4">
        <label
          for="telefone"
          class="block text-gray-700 text-sm font-semibold mb-2"
          >Telefone:</label
        >
        <input
          type="tel"
          id="telefone"
          name="telefone"
          required
          pattern="\(\d{2}\)\s?\d{4,5}-\d{4}"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purplebrand focus:border-transparent transition-all duration-300"
          placeholder="(99) 99999-9999"
        />
      </div>

      <div class="mb-4">
        <label
          for="senha"
          class="block text-gray-700 text-sm font-semibold mb-2"
          >Senha:</label
        >
        <input
          type="password"
          id="senha"
          name="senha"
          minlength="8"
          required
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purplebrand focus:border-transparent transition-all duration-300"
          placeholder="********"
        />
        <ul
          id="senha-requisitos"
          class="text-xs text-gray-500 mt-2 space-y-1 pl-4"
        >
          <li id="req-8" class="flex items-center">
            <svg
              class="h-4 w-4 mr-1 text-gray-400"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
              /></svg
            >Pelo menos 8 caracteres
          </li>
          <li id="req-maiuscula" class="flex items-center">
            <svg
              class="h-4 w-4 mr-1 text-gray-400"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
              /></svg
            >Pelo menos uma letra maiúscula
          </li>
          <li id="req-numero" class="flex items-center">
            <svg
              class="h-4 w-4 mr-1 text-gray-400"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
              /></svg
            >Pelo menos um número
          </li>
          <li id="req-especial" class="flex items-center">
            <svg
              class="h-4 w-4 mr-1 text-gray-400"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
              /></svg
            >Pelo menos um caractere especial
          </li>
        </ul>
      </div>

      <div class="mb-6">
        <label
          for="confirmar_senha"
          class="block text-gray-700 text-sm font-semibold mb-2"
          >Confirmar Senha:</label
        >
        <input
          type="password"
          id="confirmar_senha"
          name="confirmar_senha"
          minlength="8"
          required
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purplebrand focus:border-transparent transition-all duration-300"
          placeholder="********"
        />
      </div>

      <div class="flex flex-col space-y-4">
        <button type="submit" class="btn-gradient-primary w-full">
          Cadastrar
        </button>
        <div class="text-center text-sm">
          <span class="text-gray-600">Já tem uma conta? </span>
          <a
            class="text-purplebrand hover:text-purplebranddark font-semibold transition-colors duration-300"
            href="{{ url_for('usuarios.login') }}"
          >
            Faça login
          </a>
        </div>

        <div class="text-center text-sm">
          <a
            class="text-gray-600 hover:text-purplebrand transition-colors duration-300"
            href="/"
          >
            ← Voltar para o início
          </a>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  const senhaInput = document.getElementById('senha')
  const req8 = document.getElementById('req-8')
  const reqMaiuscula = document.getElementById('req-maiuscula')
  const reqNumero = document.getElementById('req-numero')
  const reqEspecial = document.getElementById('req-especial')

  function updateRequirement(element, isValid) {
    element.classList.toggle('text-green-600', isValid)
    element.classList.toggle('text-gray-500', !isValid)
    element.querySelector('svg').classList.toggle('text-green-500', isValid)
    element.querySelector('svg').classList.toggle('text-gray-400', !isValid)
  }

  senhaInput.addEventListener('input', function () {
    const val = senhaInput.value
    updateRequirement(req8, val.length >= 8)
    updateRequirement(reqMaiuscula, /[A-Z]/.test(val))
    updateRequirement(reqNumero, /[0-9]/.test(val))
    updateRequirement(reqEspecial, /[^A-Za-z0-9]/.test(val))
  })

  document.addEventListener('DOMContentLoaded', function () {
    if (typeof google !== 'undefined' && '{{ GOOGLE_CLIENT_ID }}' !== '') {
      google.accounts.id.initialize({
        client_id: '{{ GOOGLE_CLIENT_ID }}',
        callback: handleCredentialResponse,
        context: 'signup' // Define o contexto como 'signup'
      })

      document.getElementById('google-signin-button').onclick = () => {
        google.accounts.id.prompt()
      }
    } else {
      console.error(
        'Google Client ID não disponível ou Google SDK não carregado.'
      )
      const googleButton = document.getElementById('google-signin-button')
      if (googleButton) {
        googleButton.disabled = true
        googleButton.textContent = 'Login com Google indisponível'
        googleButton.classList.add('opacity-50', 'cursor-not-allowed')
      }
    }
  })

  function handleCredentialResponse(response) {
    console.log('Token de ID do Google (Cadastro):', response.credential)
    fetch('/google-login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token: response.credential })
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          window.location.href = data.redirect_url
        } else {
          alert('Erro no login/cadastro com Google: ' + data.message)
        }
      })
      .catch(error => {
        console.error('Erro na comunicação com o servidor:', error)
        alert('Ocorreu um erro ao tentar fazer login/cadastro com o Google.')
      })
  }

  function decodeJwtResponse(token) {
    /* ... (mesma função de antes) ... */
    var base64Url = token.split('.')[1]
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/')
    var jsonPayload = decodeURIComponent(
      atob(base64)
        .split('')
        .map(function (c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
        })
        .join('')
    )
    return JSON.parse(jsonPayload)
  }
</script>
{% endblock content %}
